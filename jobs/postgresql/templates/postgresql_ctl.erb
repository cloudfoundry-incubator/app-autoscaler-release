#!/bin/bash

# Initializing directory path
PACKAGE_DIR=/var/vcap/packages/postgresql 
JOB_DIR=/var/vcap/jobs/postgresql 
DATA_DIR=/var/vcap/store/postgresql 
RUN_DIR=/var/vcap/sys/run/postgresql 
LOG_DIR=/var/vcap/sys/log/postgresql 
PIDFILE=${RUN_DIR}/postgresql.pid

# Getting the DB credentials
HOST="<%= p("host") %>"
PORT="<%= p("port") %>"
USER="<%= p("user") %>"
PASSWORD="<%= p("password") %>"
DBNAME="<%= p("dbname") %>"

case "$1" in
  start)
    mkdir -p $RUN_DIR
    chown -R vcap:vcap $RUN_DIR
    if [ ! -d $LOG_DIR ]; then
      mkdir -p $LOG_DIR
      chown -R vcap:vcap $LOG_DIR
    fi
    if [ ! -d $DATA_DIR -o ! -f $DATA_DIR/postgresql.conf ]; then
      mkdir -p $DATA_DIR
      chown -R vcap:vcap $DATA_DIR
      chmod -R 755 $DATA_DIR
      # initdb
      su - vcap -c "$PACKAGE_DIR/bin/initdb -E utf8 --locale en_US.UTF-8 -D $DATA_DIR"
      if [ $? != 0 ]; then
        echo "Unable to initialize the postgresql database server"
        exit 1
      fi
      mkdir -p $DATA_DIR/pg_log
      chown -R vcap:vcap $DATA_DIR/pg_log

    fi
    # Copying postgres config to data directory
    cp $JOB_DIR/config/{postgresql,pg_hba}.conf $DATA_DIR
    chown -R vcap:vcap $DATA_DIR/{postgresql,pg_hba}.conf
    echo "Starting postgresql"
    su - vcap -c "$PACKAGE_DIR/bin/pg_ctl -o \"-h $HOST -p $PORT\" -w start -D $DATA_DIR -l \"$DATA_DIR/pg_log/startup.log\""
    # Checking whether postgres started successfully
    if [ $? == 0 ]; then
      echo "Postgresql started successfully, creating database and role"
      $PACKAGE_DIR/bin/psql -U vcap -p $PORT -d postgres -c "CREATE ROLE \"$USER\"" || echo "Role not created, already exists ?"
      $PACKAGE_DIR/bin/psql -U vcap -p $PORT -d postgres -c "ALTER ROLE \"$USER\"  WITH LOGIN PASSWORD '$PASSWORD'" || echo "Password change did not happen"
      su - vcap -c "$PACKAGE_DIR/bin/createdb $DBNAME -p $PORT" || echo "Database not created, already exists ?"
      echo "Database created successfully"
      exit 0
    else
      echo "Postgresql server failed to start, please see log file for more details"
      exit 1
    fi
  exit 0
  ;;
  stop)
    echo "Stopping postgresql"
    su - vcap -c "$PACKAGE_DIR/bin/pg_ctl stop -m fast -w -D $DATA_DIR"
    while [ -e /proc/$PID ]; do sleep 0.5; done
    rm -f $PIDFILE
    ;;
  status)
    su - vcap -c "$PACKAGE_DIR/bin/pg_ctl status -D $DATA_DIR"
    ;;
  *)
    echo "Usage: $0 {start|stop|status}"
    exit 1
    ;; 
esac
